name: DEV Deploy to Terraform Deploy

on:
  push:
    branches: [ develop ]

jobs:
  deploy:
    runs-on: ubuntu-latest
  
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Decrypt terraform.tfvars.enc
        run: |
          openssl aes-256-cbc -d -salt -pbkdf2 -in terraform.tfvars.enc -out terraform.tfvars -k "${{ secrets.DEV_TFVARS_ENC_PW }}"

      - name: Export AWS credentials from tfvars
        id: export-creds
        run: |
          export AWS_ACCESS_KEY_ID=$(grep aws_access_key_id terraform.tfvars | cut -d '"' -f2)
          export AWS_SECRET_ACCESS_KEY=$(grep aws_secret_access_key terraform.tfvars | cut -d '"' -f2)
          export AWS_DEFAULT_REGION=$(grep aws_default_region terraform.tfvars | cut -d '"' -f2)

          echo "AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY" >> $GITHUB_ENV
          echo "AWS_DEFAULT_REGION=$AWS_DEFAULT_REGION" >> $GITHUB_ENV
          
      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        run: terraform plan

      - name: Terraform Apply
        run: terraform apply -auto-approve

      - name: Clean up
        run: rm -f terraform.tfvars

      - name: Notify Discord on Success
        if: success()
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          TIMESTAMP="${{ github.event.head_commit.timestamp }}"
      
          DESCRIPTION="**Repository:** \`${REPO}\`
          **Branch:** \`${BRANCH}\`
          **Commit:** \`${COMMIT_MSG}\`
          [ðŸ”— ì‹¤í–‰ ë¡œê·¸ ë³´ê¸°](${RUN_URL})"
      
          jq -n \
            --arg desc "$DESCRIPTION" \
            --arg timestamp "$TIMESTAMP" \
            '{
              "embeds": [
                {
                  "title": "âœ… ê°œë°œ í™˜ê²½ì— ë°°í¬ ì„±ê³µ",
                  "description": $desc,
                  "color": 65280,
                  "footer": { "text": "GitHub Actions - DEV Deploy" },
                  "timestamp": $timestamp
                }
              ]
            }' > payload.json
      
          curl -H "Content-Type: application/json" \
                -X POST \
                -d @payload.json \
                ${{ secrets.DISCORD_WEBHOOK_URL }}
  
      - name: Notify Discord on Failure
        if: failure()
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          TIMESTAMP="${{ github.event.head_commit.timestamp }}"
      
          DESCRIPTION="**Repository:** \`${REPO}\`
          **Branch:** \`${BRANCH}\`
          **Commit:** \`${COMMIT_MSG}\`
          [ðŸ”— ì‹¤í–‰ ë¡œê·¸ ë³´ê¸°](${RUN_URL})"
      
          jq -n \
            --arg desc "$DESCRIPTION" \
            --arg timestamp "$TIMESTAMP" \
            '{
              "embeds": [
                {
                  "title": "âŒ ê°œë°œ í™˜ê²½ì— ë°°í¬ ì‹¤íŒ¨",
                  "description": $desc,
                  "color": 16711680,
                  "footer": { "text": "GitHub Actions - DEV Deploy" },
                  "timestamp": $timestamp
                }
              ]
            }' > payload.json
      
          curl -H "Content-Type: application/json" \
                -X POST \
                -d @payload.json \
                ${{ secrets.DISCORD_WEBHOOK_URL }}