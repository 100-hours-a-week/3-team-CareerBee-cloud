name: DEV Backend Docker CICD

on:
  workflow_dispatch:
  repository_dispatch:
    types: [be-updated]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      COMMIT_HASH: ${{ github.event.client_payload.sha }}

    steps:
      - name: Checkout BE source
        uses: actions/checkout@v3
        with:
          repository: 100-hours-a-week/3-team-CareerBee-be
          token: ${{ secrets.DEV_GITHUB_TOKEN }}
          ref: develop
          path: build_deploy/be
      
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: develop
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.DEV_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.DEV_AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Set timestamp-based path (Asia/Seoul)
        run: |
          TIMESTAMP=$(TZ='Asia/Seoul' date +%Y-%m-%d_%H_%M_%S)
          echo "DEPLOY_TAG=${TIMESTAMP}_${COMMIT_HASH}" >> $GITHUB_ENV

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2
        with:
          registry: ${{ secrets.DEV_ECR_REGISTRY }}
      
      - name: Get current tag for DEPLOY_TAG (for rollback)
        run: |
          ROLLBACK_TAG=$(aws ecr describe-images \
            --repository-name backend \
            --region ap-northeast-2 \
            --query "imageDetails[?imageTags!=null] | [?(!contains(imageTags, '${{ env.DEPLOY_TAG }}') && \
              !contains(imageTags, 'latest') && !contains(imageTags, 'cache'))] \
              | sort_by(@, &imagePushedAt) | [-1].imageTags[0]" \
            --output text | head -n1)
          echo "ðŸªƒ Rollback tag: $ROLLBACK_TAG"
          echo "ROLLBACK_TAG=$ROLLBACK_TAG" >> $GITHUB_ENV
          
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with: 
          driver: docker-container
          driver-opts: image=moby/buildkit:master,network=host
          buildkitd-flags: --debug
          use: true

      - name: Build Docker image using be.Dockerfile & Push to ECR
        working-directory: docker/dev/build_deploy/be
        run: |
          docker buildx build \
            --cache-from=type=registry,ref=${{ secrets.DEV_ECR_REGISTRY }}/backend:cache \
            --cache-to=type=registry,ref=${{ secrets.DEV_ECR_REGISTRY }}/backend:cache,mode=max \
            --push \
            -f ../be.Dockerfile \
            --build-arg SENTRY_AUTH_TOKEN=${{ secrets.SENTRY_AUTH_TOKEN }} \
            -t ${{ secrets.DEV_ECR_REGISTRY }}/backend:${{ env.DEPLOY_TAG }} \
            -t ${{ secrets.DEV_ECR_REGISTRY }}/backend:latest \
            .

      - name: Health Check Webhook
        run: |
          set -e
          if [[ "$(curl --max-time 5 -s -o /dev/null -w "%{http_code}" https://webhook.dev.careerbee.co.kr/health-check)" != "200" ]]; then
            echo "âŒ Health check failed"
            echo "DISCORD_MSG=webhook_failure" >> $GITHUB_ENV
            exit 0
          fi

      - name: Trigger Deploy Webhook
        if: env.DISCORD_MSG != 'webhook_failure'
        run: |
          curl -X POST https://webhook.dev.careerbee.co.kr/deploy \
            -H "Authorization: Bearer ${{ secrets.DEV_WEBHOOK_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"backend_tag": "latest"}'

      - name: Health check and mark result
        if: env.DISCORD_MSG != 'webhook_failure'
        run: |
          for i in $(seq 1 5); do
            STATUS=$(curl --max-time 5 -s -o /dev/null -w "%{http_code}" "https://api.dev.careerbee.co.kr/health-check")
            echo "Status: $STATUS"
            if [ "$STATUS" == "200" ]; then
              echo "âœ… Health check passed"
              echo "DISCORD_MSG=success" >> $GITHUB_ENV
              exit 0
            fi
            sleep 10
          done
          echo "âŒ Health check failed"
          echo "DISCORD_MSG=failure" >> $GITHUB_ENV
          exit 0

      - name: Rollback
        if: ${{ env.DISCORD_MSG == 'failure' && env.ROLLBACK_TAG != '' }}
        run: |
          echo "âš ï¸ ë¡¤ë°± ì‹œìž‘: íƒœê·¸ â†’ ${{ env.ROLLBACK_TAG }}"
          curl -X POST https://webhook.dev.careerbee.co.kr/deploy \
            -H "Authorization: Bearer ${{ secrets.DEV_WEBHOOK_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"backend_tag": "${{ env.ROLLBACK_TAG }}"}'

          echo "ðŸ§¹ ECRì—ì„œ íƒœê·¸ '${{ env.DEPLOY_TAG }}' ì´ë¯¸ì§€ ì‚­ì œ ì¤‘..."

          aws ecr batch-delete-image \
            --repository-name backend \
            --region ap-northeast-2 \
            --image-ids imageTag=${{ env.DEPLOY_TAG }} imageTag=latest

          echo "âœ… ì´ë¯¸ì§€ ì‚­ì œ ì™„ë£Œ"

      - name: Notify Discord
        if: always()
        run: |
          TITLE=""
          DESC=""

          if [ "${{ env.DISCORD_MSG }}" = "success" ]; then
            TITLE="âœ… ê°œë°œ í™˜ê²½ì— ë°±ì—”ë“œ ë°°í¬ ì„±ê³µ"
            DESC="ëª¨ë‘ ë°°í¬ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤.
            **ë°°í¬ íƒœê·¸:** \`${{ env.DEPLOY_TAG }}\`"
            COLOR=65280
          elif [ "${{ env.DISCORD_MSG }}" = "failure" ]; then
            TITLE="âŒ ê°œë°œ í™˜ê²½ì— ë°±ì—”ë“œ ë°°í¬ ì‹¤íŒ¨"
            DESC="ë°°í¬ì— ì‹¤íŒ¨í•˜ì—¬ ë¡¤ë°±í•˜ì˜€ìŠµë‹ˆë‹¤.
            **ë¡¤ë°± íƒœê·¸:** \`${{ env.ROLLBACK_TAG }}\`"
            COLOR=16711680
          elif [ "${{ env.DISCORD_MSG }}" = "rollback_failure" ]; then
            TITLE="âŒ ê°œë°œ í™˜ê²½ì— ë°±ì—”ë“œ ë°°í¬ & ë¡¤ë°± ì‹¤íŒ¨"
            DESC="ë¡¤ë°±í•  íƒœê·¸ê°€ ì—†ì–´ ë°°í¬ì™€ ë¡¤ë°± ëª¨ë‘ ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤."
            COLOR=16711680
          elif [ "${{ env.DISCORD_MSG }}" = "webhook_failure" ]; then
            TITLE="âš ï¸ ê°œë°œ í™˜ê²½ì— ë°±ì—”ë“œ ë°°í¬ ì¤‘ë‹¨ - ì›¹í›… ì ‘ê·¼ ì‹¤íŒ¨"
            DESC="ì›¹í›… í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ë¡œ ì¸í•´ ë°°í¬ê°€ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤."
            COLOR=16753920
          else
            TITLE="âš ï¸ ê°œë°œ í™˜ê²½ì— ë°±ì—”ë“œ ë°°í¬ ìƒíƒœ ì•Œ ìˆ˜ ì—†ìŒ"
            DESC="ì›Œí¬í”Œë¡œ ë¡œê·¸ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”."
            COLOR=16753920
          fi

          REPO="${{ github.event.client_payload.repository }}"
          BRANCH="${{ github.event.client_payload.branch }}"
          COMMIT_MSG="${{ github.event.client_payload.commit_msg }}"
          TIMESTAMP="${{ github.event.client_payload.timestamp }}"
          RUN_URL="https://github.com/$REPO/commit/${{ github.event.client_payload.sha }}"

          DESCRIPTION="**Repository:** \`${REPO}\`
          **Branch:** \`${BRANCH}\`
          **Commit:** \`${COMMIT_MSG}\`
          
          ${DESC}
          [ðŸ”— ì‹¤í–‰ ë¡œê·¸ ë³´ê¸°](${RUN_URL})"

          jq -n \
            --arg title "$TITLE" \
            --arg desc "$DESCRIPTION" \
            --arg timestamp "$TIMESTAMP" \
            --argjson color "$COLOR" \
            '{
              "embeds": [
                {
                  "title": $title,
                  "description": $desc,
                  "color": $color,
                  "footer": { "text": "GitHub Actions - DEV Deploy(BE)" },
                  "timestamp": $timestamp
                }
              ]
            }' > payload.json

          curl -H "Content-Type: application/json" \
              -X POST \
              -d @payload.json \
              ${{ secrets.DISCORD_WEBHOOK_URL }}