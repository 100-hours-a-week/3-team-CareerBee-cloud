name: Terraform Apply (Dev)

on:
  push:
    branches: [ feature/docker_dev ]

  workflow_dispatch:

  schedule:
    - cron: '20 3 * * 1-5'

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      TERRAFORM_DIR: docker/dev

    steps:
      - name: Checkout develop branch
        uses: actions/checkout@v3
        with:
          ref: feature/docker_dev

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6
          
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.DEV_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.DEV_AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Download terraform.tfvars from S3
        working-directory: ${{ env.TERRAFORM_DIR }}
        run: |
          aws s3 cp s3://${{ secrets.DEV_S3_INFRA_NAME }}/terraform.tfvars.enc terraform.tfvars.enc
          openssl aes-256-cbc -d -salt -pbkdf2 -in terraform.tfvars.enc -out terraform.tfvars -k "${{ secrets.DEV_TFVARS_ENC_PW }}"
          sorce ./terraform.tfvars

          echo "::add-mask::$S3_BUCKET_NAME"
          echo "::add-mask::$DB_PASSWORD"

          echo "S3_BUCKET_NAME=$S3_BUCKET_NAME" >> $GITHUB_ENV
          echo "DB_PASSWORD=$DB_PASSWORD" >> $GITHUB_ENV

      - name: Terraform Init
        working-directory: ${{ env.TERRAFORM_DIR }}
        run: terraform init

      - name: Terraform Plan
        working-directory: ${{ env.TERRAFORM_DIR }}
        run: terraform plan

      - name: Terraform Apply
        working-directory: ${{ env.TERRAFORM_DIR }}
        run: terraform apply -auto-approve

      - name: Wait for EC2 and GCE startup
        run: |
          set +e 

          echo "ðŸ•‘ ì´ˆê¸° 5ë¶„ ëŒ€ê¸° ì¤‘..."
          sleep 120  # 2ë¶„ ëŒ€ê¸°

          MAX_RETRIES=30
          RETRY_DELAY=30
          COUNT=0

          PARAMS=(
            "/careerbee/dev/db"
            "/careerbee/dev/service"
            "/careerbee/dev/openvpn"
            "/careerbee/dev/gce"
          )

          while [ $COUNT -lt $MAX_RETRIES ]; do
            echo "ì‹œë„ $((COUNT + 1)) / $MAX_RETRIES"

            ALL_READY=true

            for PARAM in "${PARAMS[@]}"; do
              VALUE=$(aws ssm get-parameter \
                --name "$PARAM" \
                --query 'Parameter.Value' \
                --output text \
                --region ap-northeast-2 2>/dev/null || echo "not-found")

              echo "$PARAM = $VALUE"

              if [ "$VALUE" != "ready" ]; then
                ALL_READY=false
              fi
            done

            if [ "$ALL_READY" = true ]; then
              echo "âœ… ëª¨ë“  ì„œë¹„ìŠ¤ê°€ ready ìƒíƒœìž…ë‹ˆë‹¤."
              break
            fi

            echo "â³ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì€ ì„œë¹„ìŠ¤ê°€ ìžˆìŠµë‹ˆë‹¤. $RETRY_DELAYì´ˆ í›„ ìž¬ì‹œë„..."
            sleep $RETRY_DELAY
            COUNT=$((COUNT + 1))

          if [ $COUNT -eq $MAX_RETRIES ]; then
            echo "âŒ ì œí•œ ì‹œê°„ ì´ˆê³¼. ëª¨ë“  ì„œë¹„ìŠ¤ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 1
          fi

          set -e

      - name: Get EC2 Instance ID from Name
        id: ec2
        run: |
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=ec2-careerbee-dev-azone-service" \
                      "Name=instance-state-name,Values=running" \
            --query "Reservations[].Instances[].InstanceId" \
            --output text)

          if [ -z "$INSTANCE_ID" ]; then
            echo "âŒ Instance not found!"
            exit 1
          fi

          echo "âœ… Found EC2 Instance ID: $INSTANCE_ID"
          echo "instance_id=$INSTANCE_ID" >> "$GITHUB_OUTPUT"

      - name: Get DB Private IP from EC2 Name
        id: db
        run: |
          DB_PRIVATE_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=ec2-careerbee-dev-azone-db" \
                      "Name=instance-state-name,Values=running" \
            --query "Reservations[].Instances[].PrivateIpAddress" \
            --output text)

          if [ -z "$DB_PRIVATE_IP" ]; then
            echo "âŒ DB instance not found!"
            exit 1
          fi

          echo "DB Private IP: $DB_PRIVATE_IP"
          echo "db_ip=$DB_PRIVATE_IP" >> "$GITHUB_OUTPUT"
          
      - name: DB restore
        run: |
          LATEST_BACKUP=$(aws s3 ls ${{ env.S3_BUCKET_NAME }}/db/ | sort | tail -n 1 | awk '{print $4}')

          aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --comment "download from S3 and Dump MySQL" \
            --instance-ids "${{ steps.ec2.outputs.instance_id }}" \
            --parameters commands=[
              "aws s3 cp s3://${{ env.S3_BUCKET_NAME }}/db/${LATEST_BACKUP} ${LATEST_BACKUP}"
              "mysqldump -h ${{ steps.db.outputs.db_ip }} -u root -p"${{ env.DB_PASSWORD }}" careerbee < ${LATEST_BACKUP}",
            ] \
            --region ap-northeast-2

      - name: Check Application Health
        run: |
          for i in $(seq 1 5); do
            echo "ðŸ” í—¬ìŠ¤ ì²´í¬ ì‹œë„ $i / 5..."

            FRONT_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://dev.careerbee.co.kr/health-check")
            BACK_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://dev-api.careerbee.co.kr/health-check")
            AI_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://dev-ai.careerbee.co.kr/health-check")

            if [ "$FRONT_STATUS" = "200" ] && [ "$BACK_STATUS" = "200" ] && [ "$AI_STATUS" = "200" ]; then
              echo "âœ… ëª¨ë“  ì„œë²„ ìƒíƒœ ì •ìƒ"
              exit 0
            fi

            sleep 10
          done

          # 5ë²ˆ ì‹œë„ í›„ì—ë„ ëª¨ë‘ ì‹¤íŒ¨
          echo "EC2 ì„œë²„ ìƒíƒœ: $FRONT_STATUS"
          echo "GCE ì„œë²„ ìƒíƒœ: $BACK_STATUS"
          echo "AI ì„œë²„ ìƒíƒœ: $AI_STATUS"

          exit 1

      # - name: Notify Discord on Success
      #   if: success()
      #   run: |
      #     jq -n \
      #       '{
      #         "embeds": [
      #           {
      #             "title": "ðŸš€ DEV ì„œë²„ ì‹œìž‘",
      #             "description": "ì»¤ë¦¬ì–´ë¹„ DEV ì„œë²„ê°€ ì‹œìž‘ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì˜¤ëŠ˜ë„ ì—´ì‹¬ížˆ ì¼í•´ìš”! ðŸ’ªðŸ»ðŸ’ªðŸ»",
      #             "color": 5763719,
      #             "footer": { "text": "Cloud Functions - DEV Server" },
      #             "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
      #           }
      #         ]
      #       }' > payload.json

      #     curl -H "Content-Type: application/json" \
      #         -X POST \
      #         -d @payload.json \
      #         ${{ secrets.SERVER_DISCORD_WEBHOOK_URL }}

      # - name: Notify Discord on Failure
      #   if: failure()
      #   run: |
      #     RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      #     jq -n \
      #       --arg RUN_URL "$RUN_URL"
      #       '{
      #         "embeds": [
      #           {
      #             "title": "âŒ DEV ì„œë²„ ë°°í¬ ì‹¤íŒ¨",
      #             "description": "ì›Œí¬í”Œë¡œ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\në¡œê·¸ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”. ðŸ”\n\n[ðŸ”— ì‹¤í–‰ ë¡œê·¸ ë³´ê¸°](\($RUN_URL))",
      #             "color": 15548997,
      #             "footer": { "text": "Cloud Functions - DEV Server" },
      #             "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
      #           }
      #         ]
      #       }' > payload.json

      #     curl -H "Content-Type: application/json" \
      #         -X POST \
      #         -d @payload.json \
      #         ${{ secrets.DISCORD_WEBHOOK_URL }}